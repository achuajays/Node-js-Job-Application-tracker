---
# ═══════════════════════════════════════════════════
# Common Role — Base server provisioning
# ═══════════════════════════════════════════════════

- name: Update apt cache
  apt:
    update_cache: yes
    cache_valid_time: 3600

- name: Install base packages
  apt:
    name:
      - curl
      - wget
      - git
      - jq
      - unzip
      - htop
      - vim
      - ca-certificates
      - gnupg
      - lsb-release
      - apt-transport-https
      - software-properties-common
      - ufw
    state: present

- name: Create deploy user
  user:
    name: deploy
    shell: /bin/bash
    groups: sudo
    append: yes
    create_home: yes

- name: Set authorized keys for deploy user
  authorized_key:
    user: deploy
    key: "{{ lookup('file', '~/.ssh/id_rsa.pub') }}"
    state: present

- name: Configure UFW - default deny incoming
  ufw:
    direction: incoming
    policy: deny

- name: Configure UFW - default allow outgoing
  ufw:
    direction: outgoing
    policy: allow

- name: UFW - Allow SSH
  ufw:
    rule: allow
    port: "22"
    proto: tcp

- name: UFW - Allow HTTP
  ufw:
    rule: allow
    port: "80"
    proto: tcp

- name: UFW - Allow HTTPS
  ufw:
    rule: allow
    port: "443"
    proto: tcp

- name: Enable UFW
  ufw:
    state: enabled

- name: Set timezone
  timezone:
    name: UTC

- name: Configure sysctl for performance
  sysctl:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    sysctl_set: yes
    reload: yes
  loop:
    - { key: "net.core.somaxconn", value: "65535" }
    - { key: "vm.swappiness", value: "10" }
    - { key: "net.ipv4.tcp_max_syn_backlog", value: "65535" }

- name: Set file descriptor limits
  pam_limits:
    domain: "*"
    limit_type: "{{ item.type }}"
    limit_item: nofile
    value: "65535"
  loop:
    - { type: soft }
    - { type: hard }
